// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String? // For email/password login
  phone         String?
  userType      String    @default("customer") // "customer" or "partner"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  partnerInfo   PartnerInfo?
  voyagersClub  VoyagersClub?
  bookings      Booking[]
  snsAccounts   SnsAccount[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// MSC Cruises Custom Models
model PartnerInfo {
  id                String   @id @default(cuid())
  userId            String   @unique
  companyName       String
  businessNumber    String
  representativeName String
  address           String
  commissionRate    Float    @default(0.08)
  subpageUrl        String   @unique
  status            String   @default("pending") // "pending", "active", "suspended"
  approvedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings          Booking[]
}

model VoyagersClub {
  id               String   @id @default(cuid())
  userId           String   @unique
  membershipNumber String   @unique
  tier             String   @default("classic") // "classic", "silver", "gold", "black"
  points           Int      @default(0)
  joinedAt         DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Booking {
  id              String   @id @default(cuid())
  userId          String
  bookingNumber   String   @unique
  cruiseId        String
  cruiseName      String
  shipName        String
  departureDate   DateTime
  returnDate      DateTime
  departurePort   String
  cabinCategory   String
  cabinNumber     String?
  totalPrice      Float
  currency        String   @default("USD")
  status          String   @default("pending") // "pending", "confirmed", "cancelled", "completed"
  paymentStatus   String   @default("pending") // "pending", "paid", "refunded"
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Package info
  isPackage       Boolean  @default(false)
  outboundFlight  String?
  returnFlight    String?
  packageDiscount Float?

  // Partner info
  partnerId       String?
  partnerCommission Float?

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  partner         PartnerInfo? @relation(fields: [partnerId], references: [id])
  passengers      Passenger[]
}

model Passenger {
  id            String   @id @default(cuid())
  bookingId     String
  firstName     String
  lastName      String
  dateOfBirth   DateTime
  passportNumber String?
  nationality   String
  isPrimary     Boolean  @default(false)
  createdAt     DateTime @default(now())

  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

// Cruise Product Model
model Cruise {
  id              String   @id @default(cuid())
  name            String
  shipName        String
  description     String?
  departurePort   String
  destinations    String   // JSON array of destinations
  durationDays    Int
  startingPrice   Float
  currency        String   @default("USD")
  status          String   @default("active") // "active", "inactive", "draft"
  featured        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  media           CruiseMedia[]
  cruiseItineraries CruiseItinerary[]
  flightItineraries FlightItinerary[]
  snsPosts        SnsPost[]
}

// Cruise Media Model (Images & Videos)
model CruiseMedia {
  id              String   @id @default(cuid())
  cruiseId        String
  type            String   // "image" or "video"
  url             String
  filename        String
  filesize        Int?     // in bytes
  mimeType        String?
  width           Int?
  height          Int?
  duration        Int?     // for videos, in seconds
  isPrimary       Boolean  @default(false) // 대표 이미지/비디오
  order           Int      @default(0)
  alt             String?
  caption         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  cruise          Cruise   @relation(fields: [cruiseId], references: [id], onDelete: Cascade)

  @@index([cruiseId])
}

// Cruise Itinerary Model (Route Management)
model CruiseItinerary {
  id              String   @id @default(cuid())
  cruiseId        String
  day             Int      // Day number (1-based)
  portType        String   // "departure", "port_of_call", "arrival"
  port            String   // Port name
  portCode        String?  // IATA/port code (e.g., MIA, BCN)
  country         String?  // Country name
  latitude        Float?   // GPS coordinates
  longitude       Float?   // GPS coordinates
  arrival         String?  // Time of arrival (HH:MM format)
  departure       String?  // Time of departure (HH:MM format)
  durationHours   Int?     // Hours spent at port
  activities      String?  // JSON array of activities
  description     String?  // Port description
  imageUrl        String?  // Port image
  order           Int      @default(0) // Display order
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  cruise          Cruise   @relation(fields: [cruiseId], references: [id], onDelete: Cascade)

  @@index([cruiseId])
  @@index([day])
  @@index([portType])
}

// SNS Account Model (for social media posting)
model SnsAccount {
  id              String   @id @default(cuid())
  userId          String   // Admin or Partner who owns this account
  platform        String   // "facebook", "instagram", "tiktok", "threads"
  accountId       String   // Platform-specific account ID or username
  accessToken     String?  // Encrypted access token
  refreshToken    String?  // Encrypted refresh token
  tokenExpiresAt  DateTime?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  posts           SnsPost[]

  @@unique([userId, platform, accountId])
  @@index([userId])
}

// SNS Post Model (scheduled posts)
model SnsPost {
  id              String   @id @default(cuid())
  cruiseId        String
  snsAccountId    String
  platform        String   // "facebook", "instagram", "tiktok", "threads"
  content         String   // Post text content
  mediaUrls       String?  // JSON array of media URLs
  hashtags        String?  // Comma-separated hashtags
  status          String   @default("scheduled") // "scheduled", "confirmed", "posted", "failed"
  scheduledAt     DateTime // When to post
  postedAt        DateTime?
  platformPostId  String?  // ID from the platform after posting
  errorMessage    String?  // Error message if failed
  createdBy       String   // User ID who created this post
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  cruise          Cruise   @relation(fields: [cruiseId], references: [id], onDelete: Cascade)
  snsAccount      SnsAccount @relation(fields: [snsAccountId], references: [id], onDelete: Cascade)

  @@index([cruiseId])
  @@index([snsAccountId])
  @@index([status])
  @@index([scheduledAt])
}

// Flight Itinerary Model (항공 경로 관리)
model FlightItinerary {
  id              String   @id @default(cuid())
  cruiseId        String
  segmentType     String   // "outbound" (가는편), "return" (오는편)
  flightNumber    String   // Flight number (e.g., KE123, OZ456)
  airline         String   // Airline name
  airlineCode     String?  // IATA airline code (e.g., KE, OZ)

  // Departure info
  departureAirport String  // Airport name
  departureCode   String   // IATA airport code (e.g., ICN, LAX)
  departureCity   String?  // City name
  departureCountry String? // Country name
  departureTime   String   // Departure time (HH:MM format)
  departureDate   DateTime // Departure date
  departureTerminal String? // Terminal info

  // Arrival info
  arrivalAirport  String   // Airport name
  arrivalCode     String   // IATA airport code
  arrivalCity     String?  // City name
  arrivalCountry  String?  // Country name
  arrivalTime     String   // Arrival time (HH:MM format)
  arrivalDate     DateTime // Arrival date
  arrivalTerminal String?  // Terminal info

  // Flight details
  duration        Int?     // Flight duration in minutes
  aircraft        String?  // Aircraft type (e.g., Boeing 777)
  cabinClass      String?  // "economy", "business", "first"
  stops           Int      @default(0) // Number of stops
  stopoverInfo    String?  // JSON array of stopover details

  // Booking info
  bookingClass    String?  // Booking class code
  seatInfo        String?  // Seat information
  baggageAllowance String? // Baggage allowance info
  mealService     Boolean  @default(true)

  order           Int      @default(0) // Display order
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  cruise          Cruise   @relation(fields: [cruiseId], references: [id], onDelete: Cascade)

  @@index([cruiseId])
  @@index([segmentType])
  @@index([departureDate])
}
